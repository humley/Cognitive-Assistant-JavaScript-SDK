"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var h,g=a[Symbol.iterator]();!(d=(h=g.next()).done)&&(c.push(h.value),!b||c.length!==b);d=!0);}catch(a){e=!0,f=a}finally{try{!d&&g.return&&g.return()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),__awaiter=function(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d.throw(a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b)).next())})},humleyConversationBot=function(){function a(b,c){_classCallCheck(this,a),this.baseUri="http://api.humley.com/conversation/live/Conversation.svc",this.allowfeedback=!0,this.credential=b,void 0!==c&&(this.allowfeedback=c)}return _createClass(a,[{key:"init",value:function(b){return __awaiter(this,void 0,Promise,regeneratorRuntime.mark(function a(){var c;return regeneratorRuntime.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return this.baseData=b,c=this.buildStartData(),d.next=4,this.startClient(c);case 4:return d.abrupt("return",d.sent);case 5:case"end":return d.stop()}},a,this)}))}},{key:"talk",value:function(b){return __awaiter(this,void 0,Promise,regeneratorRuntime.mark(function a(){var c;return regeneratorRuntime.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return c=this.buildChatData(this.cid,this.uuid,b),d.next=3,this.talkClient(c);case 3:return d.abrupt("return",d.sent);case 4:case"end":return d.stop()}},a,this)}))}},{key:"sendCheckPoint",value:function(b,c,d){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function a(){var e;return regeneratorRuntime.wrap(function(f){for(;;)switch(f.prev=f.next){case 0:e=new CheckPoint(this.credential.productId+5e3),e.CheckPointReachedWithVariable({checkpointID:b,variableName:c,variableValue:d}).then(function(a){},function(a){console.log(a)});case 2:case"end":return f.stop()}},a,this)}))}},{key:"sendFeedback",value:function(b){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function a(){var c;return regeneratorRuntime.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:c=new QuestionFeedback({username:this.credential.username,password:this.credential.password}),c.sendFeedback({aid:this.feedbackAnswerID,fl:b,lid:this.QALogID});case 2:case"end":return d.stop()}},a,this)}))}},{key:"entries",value:regeneratorRuntime.mark(function a(b){var c,d,e,f,g,h;return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:c=!0,d=!1,e=void 0,i.prev=3,f=Object.keys(b)[Symbol.iterator]();case 5:if(c=(g=f.next()).done){i.next=12;break}return h=g.value,i.next=9,[h,b[h]];case 9:c=!0,i.next=5;break;case 12:i.next=18;break;case 14:i.prev=14,i.t0=i.catch(3),d=!0,e=i.t0;case 18:i.prev=18,i.prev=19,!c&&f.return&&f.return();case 21:if(i.prev=21,!d){i.next=24;break}throw e;case 24:return i.finish(21);case 25:return i.finish(18);case 26:case"end":return i.stop()}},a,this,[[3,14,18,26],[19,,21,25]])})},{key:"buildStartData",value:function(){var b=void 0;b="";var c=!0,d=!1,e=void 0;try{for(var g,f=this.entries(this.baseData.params)[Symbol.iterator]();!(c=(g=f.next()).done);c=!0){var h=_slicedToArray(g.value,2),i=h[0],j=h[1];b+=""===b?i+"^"+j:","+i+"^"+j}}catch(a){d=!0,e=a}finally{try{!c&&f.return&&f.return()}finally{if(d)throw e}}return{u:this.credential.username,p:this.credential.password,params:b,uuid:this.baseData.uuid,hid:this.credential.productId,cv:this.baseData.cv,mx:this.baseData.mx,imei:this.baseData.imei,udid:this.baseData.udid,ua:navigator.userAgent,noid:this.baseData.noid,simid:this.baseData.simid,imsi:this.baseData.imsi,l:navigator.language,dt:moment().format("YYYY-MM-DD h:mm:ss")}}},{key:"buildChatData",value:function(b,c,d){return{u:this.credential.username,p:this.credential.password,q:d,uuid:c,hid:this.credential.productId,cv:this.baseData.cv,mx:this.baseData.mx,imei:this.baseData.imei,udid:this.baseData.udid,ua:navigator.userAgent,noid:this.baseData.noid,simid:this.baseData.simid,imsi:this.baseData.imsi,l:navigator.language,dt:moment().format("YYYY-MM-DD h:mm:ss"),cid:b}}},{key:"isInt",value:function(b){var c;return!isNaN(b)&&(c=parseFloat(b),(0|c)===c)}},{key:"startClient",value:function(b){return __awaiter(this,void 0,Promise,regeneratorRuntime.mark(function a(){var d,c=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return d=this,e.abrupt("return",new Promise(function(a,e){$.soap({url:c.baseUri,method:"OpenConv",SOAPAction:"http://tempuri.org/IConversation/OpenConv",appendMethodToURL:!1,envAttributes:{c:"http://schemas.xmlsoap.org/soap/encoding/",d:"http://www.w3.org/2001/XMLSchema",i:"http://www.w3.org/2001/XMLSchema-instance"},namespaceURL:"http://tempuri.org/",data:b,success:function(c){var e=c.toJSON();d.cid=d.isInt(e.Body.OpenConvResponse.OpenConvResult.cid)?e.Body.OpenConvResponse.OpenConvResult.cid:"",d.uuid=d.isInt(e.Body.OpenConvResponse.OpenConvResult.uuid)?e.Body.OpenConvResponse.OpenConvResult.uuid:"";var f=new CheckPoint(d.credential.productId+5e3);f.createSession({IMEI:d.baseData.imei,UUID:d.uuid,sendCheckPoint:!0}),a(!0)},error:function(c){var f=(c.toJSON(),new CheckPoint(d.credential.productId+5e3));f.CheckPointReachedWithVariable({checkpointID:"8064",variableName:"Client Error",variableValue:Array.prototype.slice.call(arguments).toString()}).then(function(a){},function(a){console.log(a)}),a(!1)}})}));case 2:case"end":return e.stop()}},a,this)}))}},{key:"talkClient",value:function(b){return __awaiter(this,void 0,Promise,regeneratorRuntime.mark(function a(){var d,c=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return d=this,e.abrupt("return",new Promise(function(a,e){$.soap({url:c.baseUri,method:"Talk",SOAPAction:"http://tempuri.org/IConversation/Talk",appendMethodToURL:!1,envAttributes:{c:"http://schemas.xmlsoap.org/soap/encoding/",d:"http://www.w3.org/2001/XMLSchema",i:"http://www.w3.org/2001/XMLSchema-instance"},namespaceURL:"http://tempuri.org/",data:b,success:function(c){var e=c.toJSON(),f=!1;d.cid=d.isInt(e.Body.TalkResponse.TalkResult.cid)?e.Body.TalkResponse.TalkResult.cid:"",d.uuid=d.isInt(e.Body.TalkResponse.TalkResult.uuid)?e.Body.TalkResponse.TalkResult.uuid:"";var g=void 0;if(g=[],"true"===e.Body.TalkResponse.TalkResult.ef)f=!0;else{var h=e.Body.TalkResponse.TalkResult.al.Banner;null!==h&&"[object Array]"!==Object.prototype.toString.call(h)&&(h=[h]);for(var i=0;i<h.length;i++){var j=[];"1"!==h[i].QAMD.QAType&&"2"!==h[i].QAMD.QAType||(d.feedbackAnswerID=h[i].QAMD.QAAnsID,d.QALogID=h[i].QAMD.QALogID);var k="[object Object]"!==h[i].VI.VU.toString();j={replyId:h[i].BannerID,actionType:h[i].ActionType,actionURL:h[i].ActionURL,category:h[i].CAT,buttonId:"[object Object]"!==h[i].QAMD.QAButtonID.toString()?parseInt(h[i].QAMD.QAButtonID):"[object Object]"!==h[i].VI.VB.toString()?parseInt(h[i].VI.VB):void 0,confidence:"[object Object]"!==h[i].QAMD.QAConf.toString()?parseInt(h[i].QAMD.QAConf):-1,reply:h[i].QAMD.QAHTML,hasVideo:k,video:{header:k?h[i].VI.VH:void 0,url:k?"2"===h[i].VI.VT?"https://www.youtube-nocookie.com/embed/"+h[i].VI.VU:h[i].VI.VU:void 0}},(j.buttonId!==-1||j.buttonId===-1&&d.allowfeedback)&&g.push(j)}}a({question:e.Body.TalkResponse.TalkResult.q,error:f,replies:g,errorInfo:f?e.Body.TalkResponse.TalkResult.ec:-1})},error:function(c){var f=(c.toJSON(),new CheckPoint(d.credential.productId+5e3));f.CheckPointReachedWithVariable({checkpointID:"8064",variableName:"Client Error",variableValue:Array.prototype.slice.call(arguments).toString()}).then(function(a){},function(a){console.log(a)}),a({question:"",error:!0,replies:[],errorInfo:c.toJSON()})}})}));case 2:case"end":return e.stop()}},a,this)}))}}]),a}();