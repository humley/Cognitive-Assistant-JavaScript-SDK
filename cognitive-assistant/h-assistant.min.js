"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _slicedToArray=function(){function e(e,t){var r=[],n=!0,a=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(c){a=!0,i=c}finally{try{!n&&s["return"]&&s["return"]()}finally{if(a)throw i}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),__awaiter=function(e,t,r,n){return new(r||(r=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(t){i(t)}}function s(e){try{c(n["throw"](e))}catch(t){i(t)}}function c(e){e.done?a(e.value):new r(function(t){t(e.value)}).then(o,s)}c((n=n.apply(e,t)).next())})},humleyConversationBot=function(){function e(t,r){_classCallCheck(this,e),this.baseUri="http://api.humley.com/conversation/live/Conversation.svc",this.allowfeedback=!0,this.credential=t,void 0!==r&&(this.allowfeedback=r)}return _createClass(e,[{key:"init",value:function(e){return __awaiter(this,void 0,Promise,regeneratorRuntime.mark(function t(){var r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.baseData=e,r=this.buildStartData(),t.next=4,this.startClient(r);case 4:return t.abrupt("return",t.sent);case 5:case"end":return t.stop()}},t,this)}))}},{key:"talk",value:function(e){return __awaiter(this,void 0,Promise,regeneratorRuntime.mark(function t(){var r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=this.buildChatData(this.cid,this.uuid,e),t.next=3,this.talkClient(r);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}},t,this)}))}},{key:"sendCheckPoint",value:function(e,t,r){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function n(){var a;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:a=new CheckPoint(this.credential.productId+5e3),a.CheckPointReachedWithVariable({checkpointID:e,variableName:t,variableValue:r}).then(function(e){},function(e){console.log(e)});case 2:case"end":return n.stop()}},n,this)}))}},{key:"sendFeedback",value:function(e){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function t(){var r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:r=new QuestionFeedback({username:this.credential.username,password:this.credential.password}),r.sendFeedback({aid:this.feedbackAnswerID,fl:e,lid:this.QALogID});case 2:case"end":return t.stop()}},t,this)}))}},{key:"entries",value:regeneratorRuntime.mark(function t(e){var r,n,a,i,o,s;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:r=!0,n=!1,a=void 0,t.prev=3,i=Object.keys(e)[Symbol.iterator]();case 5:if(r=(o=i.next()).done){t.next=12;break}return s=o.value,t.next=9,[s,e[s]];case 9:r=!0,t.next=5;break;case 12:t.next=18;break;case 14:t.prev=14,t.t0=t["catch"](3),n=!0,a=t.t0;case 18:t.prev=18,t.prev=19,!r&&i["return"]&&i["return"]();case 21:if(t.prev=21,!n){t.next=24;break}throw a;case 24:return t.finish(21);case 25:return t.finish(18);case 26:case"end":return t.stop()}},t,this,[[3,14,18,26],[19,,21,25]])})},{key:"buildStartData",value:function(){var e=void 0;e="";var t=!0,r=!1,n=void 0;try{for(var a,i=this.entries(this.baseData.params)[Symbol.iterator]();!(t=(a=i.next()).done);t=!0){var o=_slicedToArray(a.value,2),s=o[0],c=o[1];e+=""===e?s+"^"+c:","+s+"^"+c}}catch(u){r=!0,n=u}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return{u:this.credential.username,p:this.credential.password,params:e,uuid:this.baseData.uuid,hid:this.credential.productId,cv:this.baseData.cv,mx:this.baseData.mx,imei:this.baseData.imei,udid:this.baseData.udid,ua:navigator.userAgent,noid:this.baseData.noid,simid:this.baseData.simid,imsi:this.baseData.imsi,l:navigator.language,dt:moment().format("YYYY-MM-DD h:mm:ss")}}},{key:"buildChatData",value:function(e,t,r){return{u:this.credential.username,p:this.credential.password,q:r,uuid:t,hid:this.credential.productId,cv:this.baseData.cv,mx:this.baseData.mx,imei:this.baseData.imei,udid:this.baseData.udid,ua:navigator.userAgent,noid:this.baseData.noid,simid:this.baseData.simid,imsi:this.baseData.imsi,l:navigator.language,dt:moment().format("YYYY-MM-DD h:mm:ss"),cid:e}}},{key:"startClient",value:function(e){return __awaiter(this,void 0,Promise,regeneratorRuntime.mark(function t(){var r,n=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=this,t.abrupt("return",new Promise(function(t,a){$.soap({url:n.baseUri,method:"OpenConv",SOAPAction:"http://tempuri.org/IConversation/OpenConv",appendMethodToURL:!1,envAttributes:{c:"http://schemas.xmlsoap.org/soap/encoding/",d:"http://www.w3.org/2001/XMLSchema",i:"http://www.w3.org/2001/XMLSchema-instance"},namespaceURL:"http://tempuri.org/",data:e,success:function(e){var n=e.toJSON();r.cid=n.Body.OpenConvResponse.OpenConvResult.cid,r.uuid=n.Body.OpenConvResponse.OpenConvResult.uuid;var a=new CheckPoint(r.credential.productId+5e3);a.createSession({IMEI:r.baseData.imei,UUID:r.uuid,sendCheckPoint:!0}),t(!0)},error:function(e){var n=(e.toJSON(),new CheckPoint(r.credential.productId+5e3));n.CheckPointReachedWithVariable({checkpointID:"8064",variableName:"Client Error",variableValue:Array.prototype.slice.call(arguments).toString()}).then(function(e){},function(e){console.log(e)}),t(!1)}})}));case 2:case"end":return t.stop()}},t,this)}))}},{key:"talkClient",value:function(e){return __awaiter(this,void 0,Promise,regeneratorRuntime.mark(function t(){var r,n=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=this,t.abrupt("return",new Promise(function(t,a){$.soap({url:n.baseUri,method:"Talk",SOAPAction:"http://tempuri.org/IConversation/Talk",appendMethodToURL:!1,envAttributes:{c:"http://schemas.xmlsoap.org/soap/encoding/",d:"http://www.w3.org/2001/XMLSchema",i:"http://www.w3.org/2001/XMLSchema-instance"},namespaceURL:"http://tempuri.org/",data:e,success:function(e){var n=e.toJSON(),a=!1;r.cid=n.Body.TalkResponse.TalkResult.cid,r.uuid=n.Body.TalkResponse.TalkResult.uuid;var i=void 0;if(i=[],"true"===n.Body.TalkResponse.TalkResult.ef)a=!0;else{var o=n.Body.TalkResponse.TalkResult.al.Banner;null!==o&&"[object Array]"!==Object.prototype.toString.call(o)&&(o=[o]);for(var s=0;s<o.length;s++){var c=[];("1"===o[s].QAMD.QAType||"2"===o[s].QAMD.QAType)&&(r.feedbackAnswerID=o[s].QAMD.QAAnsID,r.QALogID=o[s].QAMD.QALogID);var u="[object Object]"!==o[s].VI.VU.toString();c={replyId:o[s].BannerID,actionType:o[s].ActionType,actionURL:o[s].ActionURL,category:o[s].CAT,buttonId:"[object Object]"!==o[s].QAMD.QAButtonID.toString()?parseInt(o[s].QAMD.QAButtonID):"[object Object]"!==o[s].VI.VB.toString()?parseInt(o[s].VI.VB):void 0,confidence:"[object Object]"!==o[s].QAMD.QAConf.toString()?parseInt(o[s].QAMD.QAConf):-1,reply:o[s].QAMD.QAHTML,hasVideo:u,video:{header:u?o[s].VI.VH:void 0,url:u?"2"===o[s].VI.VT?"https://www.youtube-nocookie.com/embed/"+o[s].VI.VU:o[s].VI.VU:void 0}},(-1!==c.buttonId||-1===c.buttonId&&r.allowfeedback)&&i.push(c)}}t({question:n.Body.TalkResponse.TalkResult.q,error:a,replies:i,errorInfo:a?n.Body.TalkResponse.TalkResult.ec:-1})},error:function(e){var n=(e.toJSON(),new CheckPoint(r.credential.productId+5e3));n.CheckPointReachedWithVariable({checkpointID:"8064",variableName:"Client Error",variableValue:Array.prototype.slice.call(arguments).toString()}).then(function(e){},function(e){console.log(e)}),t({question:"",error:!0,replies:[],errorInfo:e.toJSON()})}})}));case 2:case"end":return t.stop()}},t,this)}))}}]),e}();